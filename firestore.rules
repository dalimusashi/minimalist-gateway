rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * DATABASE SECURITY ARCHITECTURE & PHILOSOPHY
     * 
     * Core Philosophy: 
     * This ruleset implements a "Write-Only" public submission model for contact forms. 
     * It prioritizes the privacy of individuals reaching out via the landing page by 
     * allowing data to be captured while strictly preventing any public read access 
     * to the stored submissions.
     * 
     * Data Structure:
     * The model uses a single top-level collection: /contactFormSubmissions/{submissionId}.
     * This flat structure ensures maximum performance and simplicity for high-volume 
     * ingestion of form data.
     * 
     * Key Security Decisions:
     * 1. Write-Only Ingestion: Users (including anonymous sessions) are permitted to 
     *    create submissions, but the rules explicitly deny 'get', 'list', 'update', 
     *    and 'delete' to everyone. This ensures that once a message is sent, it 
     *    cannot be intercepted or tampered with via the client SDK.
     * 2. Identity-Based Submission: While the form is public, we require 'isSignedIn()' 
     *    (supporting the 'anonymous' provider listed in the IR) to prevent basic bot 
     *    spamming and ensure a valid Firebase Auth context exists.
     * 3. Relational Integrity: On creation, the rules mandate that the internal 'id' 
     *    field of the document must strictly match the Firestore Document ID.
     * 
     * Denormalization for Authorization:
     * As this is a flat, non-relational collection for capturing external input, 
     * no complex denormalization is required. Authorization is handled at the 
     * collection level rather than per-document ownership.
     */

    /** 
     * @section Helpers
     * Global helper functions for standardized authorization checks.
     */

    // Basic check for authenticated state. Supports anonymous and password providers.
    function isSignedIn() {
      return request.auth != null;
    }

    // Validates that the internal data ID matches the document path ID.
    function isPathConsistent(id) {
      return request.resource.data.id == id;
    }

    /**
     * @description Rules for the contact form submission collection.
     * @path /contactFormSubmissions/{contactFormSubmissionId}
     * @allow (create) if the user is signed in and the ID field matches the path.
     * @deny (get, list, update, delete) for all users to protect PII from being read or modified.
     * @principle Implements a secure "Black Box" pattern for public data ingestion.
     */
    match /contactFormSubmissions/{contactFormSubmissionId} {
      
      // Allow creation of new submissions. We validate the ID for relational integrity.
      allow create: if isSignedIn() && isPathConsistent(contactFormSubmissionId);

      // Strictly deny reading individual documents to prevent PII exposure.
      allow get: if false;

      // Strictly deny listing to prevent data harvesting of names and emails.
      allow list: if false;

      // Prevent modification of submitted messages to ensure data integrity for the business.
      allow update: if false;

      // Prevent deletion of submissions from the client to ensure no data is lost.
      allow delete: if false;
    }

  }
}